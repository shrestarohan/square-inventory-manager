<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Duplicate GTINs</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <%- include('partials/header', {
        pageTitle: pageTitle || 'Duplicate GTINs',
        currentView: 'duplicates',
        merchant: null,
        merchantId: null,
        merchants: typeof merchants !== 'undefined' ? merchants : [],
        activePage: 'duplicates-gtin',
        showFilters: false
      }) %>

  <div style="padding: 14px 16px;">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <label><strong>Merchant:</strong></label>
      <select id="merchantPick">
        <option value="">Select merchant…</option>
        <% (merchants || []).forEach(m => { %>
          <option value="<%= m.id %>"><%= m.display_name || m.id %></option>
        <% }) %>
      </select>

      <input id="filter" placeholder="Filter results (gtin, item, sku)..." style="min-width:320px;" />
      <span id="summary" style="opacity:.8;font-size:12px;"></span>
    </div>

    <div style="margin-top:8px; opacity:.75; font-size:12px;">
      Showing <strong>true duplicate GTINs</strong> (same GTIN on multiple active catalog variations).
    </div>
  </div>

  <table id="dup-table" style="width:100%;">
    <thead>
      <tr>
        <th>Count</th>
        <th>GTIN</th>
        <th>Canonical Name</th>
        <th>Items</th>
        <th>SKUs</th>
      </tr>
    </thead>
    <tbody id="dup-body">
      <tr><td colspan="5" style="padding:16px;opacity:.7;">Pick a merchant to load duplicates.</td></tr>
    </tbody>
  </table>

  <%- include('partials/footer') %>

  <script>
    const topLoader = document.getElementById('top-loader');
    const topLoaderBar = document.getElementById('top-loader-bar');
    const miniSpinner = document.getElementById('mini-spinner');
    const loadStatus = document.getElementById('load-status');

    let timer = null;
    function startLoading() {
      if (topLoader) topLoader.classList.add('is-on');
      if (miniSpinner) miniSpinner.classList.add('is-on');
      if (loadStatus) loadStatus.textContent = '';
      if (topLoaderBar) topLoaderBar.style.width = '10%';
      let p = 10;
      clearInterval(timer);
      timer = setInterval(() => {
        p = Math.min(p + Math.random() * 12, 92);
        if (topLoaderBar) topLoaderBar.style.width = p.toFixed(0) + '%';
      }, 180);
    }
    function stopLoading() {
      clearInterval(timer);
      timer = null;
      if (topLoaderBar) topLoaderBar.style.width = '100%';
      setTimeout(() => {
        if (topLoader) topLoader.classList.remove('is-on');
        if (miniSpinner) miniSpinner.classList.remove('is-on');
        if (topLoaderBar) topLoaderBar.style.width = '0%';
      }, 180);
    }

    const merchantPick = document.getElementById('merchantPick');
    const filter = document.getElementById('filter');
    const tbody = document.getElementById('dup-body');
    const summary = document.getElementById('summary');

    let lastRows = null;

    function escapeHtml(s) {
      return (s || '').toString().replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function renderRows(rows) {
      const rawQ = filter.value || '';
      const q = rawQ.trim().toLowerCase();
      const qNoSpace = q.replace(/\s+/g, '');

      const norm = (s) => (s || '').toString().toLowerCase().replace(/\s+/g, '');

      const filtered = (rows || []).filter(r => {
        if (!q) return true;

        const itemsText = (r.items || []).join(' ');
        const skusText = (r.skus || []).join(' ');

        const hay = [
          r.gtin,
          r.canonical_name,
          itemsText,
          skusText
        ].join(' ');

        const base = hay.toLowerCase();
        const noSpace = base.replace(/\s+/g, '');

        return base.includes(q) || noSpace.includes(qNoSpace);
      });

      tbody.innerHTML = '';
      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding:16px;opacity:.7;">No duplicates found.</td></tr>';
        return;
      }

      for (const r of filtered) {
        const tr = document.createElement('tr');

        const itemsShort = (r.items || []).slice(0, 6).join(', ');
        const itemsMore = (r.items || []).length > 6 ? ` (+${(r.items.length - 6)})` : '';
        const skusShort = (r.skus || []).slice(0, 8).join(', ');
        const skusMore = (r.skus || []).length > 8 ? ` (+${(r.skus.length - 8)})` : '';

        tr.innerHTML = `
          <td><strong>${r.variation_count || 0}</strong></td>
          <td>${escapeHtml(r.gtin || '')}</td>
          <td>${escapeHtml(r.canonical_name || '')}</td>
          <td>${escapeHtml(itemsShort)}${itemsMore}</td>
          <td>${escapeHtml(skusShort)}${skusMore}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function normalizeApiRows(apiRows) {
      // apiRows elements look like: { gtin, canonical_name, variation_count, variations, variations_list }
      return (apiRows || []).map(r => {
        const vars = r.variations_list
          ? r.variations_list
          : (r.variations && typeof r.variations === 'object' ? Object.values(r.variations) : []);

        const items = vars
          .map(v => (v && v.item_name) ? v.item_name : '')
          .filter(Boolean);

        const skus = vars
          .map(v => (v && v.sku) ? v.sku : '')
          .filter(Boolean);

        return {
          gtin: r.gtin,
          canonical_name: r.canonical_name || (items[0] || ''),
          variation_count: Number(r.variation_count || vars.length || 0),
          items,
          skus,
        };
      });
    }

    async function loadDupes() {
      const merchantId = merchantPick.value;
      if (!merchantId) return;

      startLoading();
      try {
        const params = new URLSearchParams();
        params.set('merchantId', merchantId);
        params.set('pageSize', '250');           // page size per request
        params.set('onlyDuplicates', '1');       // ✅ server-side filter
        params.set('q', '');                     // optional: leave blank to paginate by docId

        const res = await fetch('/api/gtin-matrix?' + params.toString(), {
          headers: { 'Accept': 'application/json' }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        // data.rows contains gtin docs
        const rows = normalizeApiRows(data.rows || []).filter(r => (r.variation_count || 0) > 1);
        lastRows = rows;

        summary.textContent =
          `merchant: ${merchantId} • duplicate GTINs shown: ${rows.length}`;

        renderRows(rows);
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="5" style="padding:16px;color:#ffb3b3;">${e.message}</td></tr>`;
      } finally {
        stopLoading();
      }
    }

    merchantPick.addEventListener('change', loadDupes);
    filter.addEventListener('input', () => lastRows && renderRows(lastRows));
  </script>
</body>
</html>
