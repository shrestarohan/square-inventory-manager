<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inventory Dashboard</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <%- include('partials/header', {
        pageTitle: 'Inventory Dashboard',
        currentView: 'item',
        merchant: typeof merchant !== 'undefined' ? merchant : null,
        merchantId: typeof merchantId !== 'undefined' ? merchantId : null,
        merchants: typeof merchants !== 'undefined' ? merchants : [],
        activePage: 'dashboard'
      }) %>

  <table id="inventory-table">
    <thead>
      <tr>
        <th>Image</th>
        <th class="sortable" data-key="merchant_name" data-type="string">Merchant</th>
        <th class="sortable" data-key="location_name" data-type="string">Location</th>
        <th class="sortable" data-key="category_name" data-type="string">Category</th>
        <th class="sortable" data-key="item_name" data-type="string">Item</th>
        <th class="sortable" data-key="variation_name" data-type="string">Variation</th>
        <th class="sortable" data-key="sku" data-type="string">SKU</th>
        <th class="sortable" data-key="gtin" data-type="string">GTIN</th>
        <th class="sortable" data-key="qty" data-type="number">Qty</th>
        <th class="sortable" data-key="state" data-type="string">State</th>
        <th class="sortable" data-key="price" data-type="number">Price</th>
        <th class="sortable" data-key="currency" data-type="string">Currency</th>
        <th class="sortable" data-key="tax_names" data-type="string">Sales Tax</th>
        <th class="sortable" data-key="calculated_at" data-type="string">Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="inventory-body"></tbody>
  </table>

  <div class="pagination">
    <span id="page-info"></span>
    <span>
      Rows per page:
      <select id="rowsPerPage">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="250">250</option>
      </select>
    </span>
    <button id="prevPage">&laquo; Prev</button>
    <button id="nextPage">Next &raquo;</button>
  </div>

  <%- include('partials/footer') %>

  <script>
    // ---------- header controls ----------
    const merchantSelect = document.getElementById('merchantSelect');
    if (merchantSelect) merchantSelect.addEventListener('change', () => {
      const val = merchantSelect.value;
      if (val) window.location.href = val;
    });

    const viewSelect = document.getElementById('viewSelect');
    if (viewSelect) viewSelect.addEventListener('change', () => {
      const val = viewSelect.value;
      if (val) window.location.href = val;
    });

    // ---------- loader elements (from header.ejs) ----------
    const topLoader = document.getElementById('top-loader');
    const topLoaderBar = document.getElementById('top-loader-bar');
    const miniSpinner = document.getElementById('mini-spinner');
    const loadStatus = document.getElementById('load-status');

    function setStatus(msg) {
      if (loadStatus) loadStatus.textContent = (msg ?? ''); // no fallback text
    }

    let loaderTimer = null;
    function startLoading(label) {
      setStatus(label ?? ''); // keep empty by default
      if (topLoader) topLoader.classList.add('is-on');
      if (miniSpinner) miniSpinner.classList.add('is-on');

      if (topLoaderBar) topLoaderBar.style.width = '10%';
      let p = 10;

      clearInterval(loaderTimer);
      loaderTimer = setInterval(() => {
        p = Math.min(p + Math.random() * 12, 92);
        if (topLoaderBar) topLoaderBar.style.width = p.toFixed(0) + '%';
      }, 180);
    }

    function stopLoading() {
      clearInterval(loaderTimer);
      loaderTimer = null;

      if (topLoaderBar) topLoaderBar.style.width = '100%';
      setTimeout(() => {
        if (topLoader) topLoader.classList.remove('is-on');
        if (miniSpinner) miniSpinner.classList.remove('is-on');
        if (topLoaderBar) topLoaderBar.style.width = '0%';
        setStatus('');
      }, 180);
    }

    // ---------- Data & table state ----------
    const DASHBOARD_MERCHANT_ID = <%- JSON.stringify(merchantId || null) %>;

    let pages = [];
    let cursors = [null];
    let currentPageIndex = 0;
    let rowsPerPage = 50;

    const tbody = document.getElementById('inventory-body');
    const pageInfo = document.getElementById('page-info');
    const rowsPerPageSelect = document.getElementById('rowsPerPage');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const headerCells = Array.from(document.querySelectorAll('#inventory-table thead th.sortable'));

    const searchInput = document.getElementById('search');
    let currentQuery = '';

    let currentRows = [];
    let currentSort = { key: null, direction: 'asc', type: 'string' };

    // Abort old fetches if user clicks/types fast
    let inflight = null;

    function mapRow(r, idx) {
      return {
        _index: idx,
        id: r.id || r.docId || '',
        merchant_name: r.merchant_name || r.merchant_id || '',
        location_name: r.location_name || r.location_id || '',
        category_name: r.category_name || '',
        item_name: r.item_name || '',
        variation_name: r.variation_name || '',
        sku: r.sku || '',
        gtin: r.gtin || '',
        qty: (r.qty !== undefined && r.qty !== null) ? Number(r.qty) : null,
        state: r.state || '',
        price: (r.price !== undefined && r.price !== null) ? Number(r.price) : null,
        currency: r.currency || '',
        tax_names: Array.isArray(r.tax_names) ? r.tax_names : [],
        tax_percentages: Array.isArray(r.tax_percentages) ? r.tax_percentages : [],
        calculated_at: r.calculated_at || r.updated_at || '',
        image_urls: Array.isArray(r.image_urls) ? r.image_urls : (r.image_urls ? [r.image_urls] : []),
        merchant_id: r.merchant_id || '',
        variation_id: r.variation_id || '',
        item_id: r.item_id || '',
      };
    }

    function renderSkeleton() {
      tbody.innerHTML = '';
      for (let i = 0; i < 8; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="15" style="padding:14px;opacity:.55;">&nbsp;</td>`;
        tbody.appendChild(tr);
      }
    }

    async function fetchPage(pageIndexToLoad) {
      const cursor = cursors[pageIndexToLoad] || null;

      const params = new URLSearchParams();
      params.set('pageSize', String(rowsPerPage));
      if (DASHBOARD_MERCHANT_ID) params.set('merchantId', DASHBOARD_MERCHANT_ID);
      if (cursor) params.set('cursor', cursor);

      // ✅ DB search
      if (currentQuery) params.set('q', currentQuery);

      const url = '/api/inventory?' + params.toString();

      if (inflight) inflight.abort();
      inflight = new AbortController();

      startLoading(); // no text

      try {
        const res = await fetch(url, {
          headers: { 'Accept': 'application/json' },
          signal: inflight.signal,
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error('Failed to load inventory: ' + txt);
        }

        const data = await res.json();
        const mapped = (data.rows || []).map(mapRow);
        const nextCursor = data.nextCursor || null;

        pages[pageIndexToLoad] = { rows: mapped, nextCursor };
        cursors[pageIndexToLoad + 1] = nextCursor;

        return mapped;
      } catch (e) {
        // ignore aborted requests
        if (e && e.name === 'AbortError') return null;
        throw e;
      } finally {
        stopLoading();
      }
    }

    async function loadPage(pageIndex) {
      currentPageIndex = pageIndex;

      if (!pages[pageIndex]) {
        renderSkeleton();
        await fetchPage(pageIndex);
      }

      let pageRows = (pages[pageIndex]?.rows || []).slice();

      // ✅ remove client-side search filter (DB does it)

      // sort within page
      if (currentSort.key) {
        const { key, type, direction } = currentSort;
        const dir = direction === 'asc' ? 1 : -1;

        pageRows.sort((a, b) => {
          const va = a[key];
          const vb = b[key];
          if (type === 'number') {
            const na = (va === null || va === undefined || isNaN(va)) ? -Infinity : Number(va);
            const nb = (vb === null || vb === undefined || isNaN(vb)) ? -Infinity : Number(vb);
            return na < nb ? -1 * dir : na > nb ? 1 * dir : 0;
          } else {
            const sa = (Array.isArray(va) ? va.join(', ') : (va ?? '')).toString().toLowerCase();
            const sb = (Array.isArray(vb) ? vb.join(', ') : (vb ?? '')).toString().toLowerCase();
            return sa < sb ? -1 * dir : sa > sb ? 1 * dir : 0;
          }
        });
      }

      currentRows = pageRows;
      renderTable();
    }

    function renderTable() {
      tbody.innerHTML = '';

      if (!currentRows.length) {
        tbody.innerHTML = '<tr><td colspan="15">No inventory rows found.</td></tr>';
        pageInfo.textContent = `Page ${currentPageIndex + 1} (0 rows)`;
        prevBtn.disabled = currentPageIndex <= 0;
        nextBtn.disabled = !(pages[currentPageIndex] && pages[currentPageIndex].nextCursor);
        return;
      }

      currentRows.forEach(r => {
        const tr = document.createElement('tr');

        const taxText =
          r.tax_names && r.tax_names.length
            ? r.tax_names.join(', ') +
              (r.tax_percentages && r.tax_percentages.length
                ? ' (' + r.tax_percentages.join(', ') + ' %)'
                : '')
            : '';

        // Image cell (clickable to upload)
        const imgTd = document.createElement('td');
        imgTd.className = 'thumb-cell';

        const wrap = document.createElement('div');
        wrap.className = 'thumb-wrap';

        const img = document.createElement('img');
        img.className = 'thumb-img clickable';
        img.loading = 'lazy';
        img.alt = r.item_name || 'Item image';

        const hasImg = r.image_urls && r.image_urls.length;
        //img.src = hasImg ? r.image_urls[0] : '/img/placeholder-thumb.png'; // or any placeholder you want
        const PLACEHOLDER_SVG = "data:image/svg+xml;utf8," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
          <rect width="100%" height="100%" rx="10" ry="10" fill="#f2f2f2"/>
          <path d="M40 24v32M24 40h32" stroke="#9aa0a6" stroke-width="4" stroke-linecap="round"/>
        </svg>
        `);
        img.src = hasImg ? r.image_urls[0] : PLACEHOLDER_SVG;

        // hidden file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';

        // click image → open picker
        img.addEventListener('click', () => fileInput.click());

        // when file selected → upload
        fileInput.addEventListener('change', async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;

          try {
            startLoading('');

            // optimistic UI: preview local image immediately
            const previewUrl = URL.createObjectURL(file);
            img.src = previewUrl;

            const fd = new FormData();
            fd.append('image', file);

            // pick ONE identifier strategy:
            // ✅ best: GTIN-based global update across merchants
            if (r.gtin) fd.append('gtin', r.gtin);

            // optional extra context (helpful for debugging)
            if (r.merchant_id) fd.append('merchantId', r.merchant_id);
            if (r.item_id) fd.append('itemId', r.item_id);

            const res = await fetch('/api/update-item-image', {
              method: 'POST',
              body: fd,
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data.success) throw new Error(data.error || 'Upload failed');

            // server returns canonical URL(s)
            if (data.imageUrl) img.src = data.imageUrl;
            img.classList.add('thumb-updated');
            setTimeout(() => img.classList.remove('thumb-updated'), 800);
          } catch (e) {
            console.error(e);
            alert('Image update failed: ' + e.message);

            // revert UI if failed
            img.src = hasImg ? r.image_urls[0] : '/img/placeholder-thumb.png';
          } finally {
            stopLoading();
            // reset input so selecting same file again triggers change
            fileInput.value = '';
          }
        });

        wrap.appendChild(img);
        wrap.appendChild(fileInput);
        imgTd.appendChild(wrap);
        tr.appendChild(imgTd);


        const cells = [
          r.merchant_name,
          r.location_name,
          r.category_name,
          r.item_name,
          r.variation_name,
          r.sku,
          r.gtin,
          (r.qty !== null && r.qty !== undefined) ? r.qty : '',
          r.state,
          (r.price !== null && r.price !== undefined) ? r.price.toFixed(2) : '',
          r.currency,
          taxText,
          r.calculated_at,
        ];

        cells.forEach(text => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });

        // Actions cell
        const tdActions = document.createElement('td');

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'btn btn-sm btn-danger'; // or your own class
        delBtn.addEventListener('click', async () => {
          const merchantId = r.merchant_id;
          const variationId = r.variation_id;
          const itemId = r.item_id;

          if (!r.gtin) {
            alert('Missing GTIN for this row. Cannot delete reliably.');
            return;
          }
          
          if (!merchantId || !variationId) {
            alert('Missing merchant/variation id for this row.');
            return;
          }

          const ok = confirm(
            `Delete this item from Square + Firestore?\n\nMerchant: ${r.merchant_name}\nItem: ${r.item_name}\nGTIN: ${r.gtin}\n\nThis is irreversible.`
          );
          if (!ok) return;

          delBtn.disabled = true;
          try {
            startLoading(''); // uses your top-loader + spinner
            const res = await fetch('/api/delete-item', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                gtin: r.gtin || '',
                merchantId,
                variationId,
                itemId,
                mode: 'variation', // change to 'item' if you want delete entire item
              }),
            });

            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.error || 'Delete failed');

            // remove row instantly (or reload page)
            tr.remove();
          } catch (e) {
            console.error(e);
            alert('Delete failed: ' + e.message);
          } finally {
            stopLoading();
            delBtn.disabled = false;
          }
        });

        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      const hasNext = pages[currentPageIndex] && pages[currentPageIndex].nextCursor;
      pageInfo.textContent = `Page ${currentPageIndex + 1} (rows: ${currentRows.length})`;
      prevBtn.disabled = currentPageIndex <= 0;
      nextBtn.disabled = !hasNext;
    }

    // sorting UI
    function clearSortIndicators() {
      headerCells.forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));
    }
    function sortBy(key, type) {
      if (!key) return;
      if (currentSort.key === key) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      else { currentSort.key = key; currentSort.direction = 'asc'; }
      currentSort.type = type || 'string';

      clearSortIndicators();
      headerCells.forEach(th => {
        if (th.dataset.key === key) th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
      });

      loadPage(currentPageIndex);
    }
    headerCells.forEach(th => th.addEventListener('click', () => sortBy(th.dataset.key, th.dataset.type || 'string')));

    // ✅ DB search (debounced)
    let searchDebounce = null;
    function resetAndReload() {
      pages = [];
      cursors = [null];
      currentPageIndex = 0;
      loadPage(0);
    }

    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
          // ✅ normalize so "375 ml" and "375ml" behave the same
          currentQuery = (searchInput.value || '')
            .trim()
            .toLowerCase()
            .replace(/\s+/g, '');

          resetAndReload(); // this should reload page 0 and fetch with q=
        }, 250);
      });
    }

    // pagination
    rowsPerPageSelect.addEventListener('change', () => {
      rowsPerPage = Number(rowsPerPageSelect.value) || 50;
      resetAndReload();
    });

    prevBtn.addEventListener('click', () => currentPageIndex > 0 && loadPage(currentPageIndex - 1));
    nextBtn.addEventListener('click', () => {
      const page = pages[currentPageIndex];
      if (page && page.nextCursor) loadPage(currentPageIndex + 1);
    });

    // initial
    (async () => {
      rowsPerPage = Number(rowsPerPageSelect.value) || 50;
      try {
        await loadPage(0);
      } catch (e) {
        console.error(e);
        stopLoading();
        tbody.innerHTML = '<tr><td colspan="15">Failed to load inventory. Check server logs.</td></tr>';
      }
    })();
  </script>

</body>
</html>
