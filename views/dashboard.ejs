<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inventory Dashboard</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <%- include('partials/header', {
        pageTitle: 'Inventory Dashboard',
        currentView: 'item',
        merchant: typeof merchant !== 'undefined' ? merchant : null,
        merchantId: typeof merchantId !== 'undefined' ? merchantId : null,
        merchants: typeof merchants !== 'undefined' ? merchants : []
      }) %>

  <table id="inventory-table">
    <thead>
      <tr>
        <th>Image</th>
        <th class="sortable" data-key="merchant_name" data-type="string">Merchant</th>
        <th class="sortable" data-key="location_name" data-type="string">Location</th>
        <th class="sortable" data-key="category_name" data-type="string">Category</th>
        <th class="sortable" data-key="item_name" data-type="string">Item</th>
        <th class="sortable" data-key="variation_name" data-type="string">Variation</th>
        <th class="sortable" data-key="sku" data-type="string">SKU</th>
        <th class="sortable" data-key="gtin" data-type="string">GTIN</th>
        <th class="sortable" data-key="qty" data-type="number">Qty</th>
        <th class="sortable" data-key="state" data-type="string">State</th>
        <th class="sortable" data-key="price" data-type="number">Price</th>
        <th class="sortable" data-key="currency" data-type="string">Currency</th>
        <th class="sortable" data-key="tax_names" data-type="string">Sales Tax</th>
        <th class="sortable" data-key="calculated_at" data-type="string">Updated</th>
      </tr>
    </thead>
    <tbody id="inventory-body">
      <!-- Rows rendered by JS -->
    </tbody>
  </table>

  <div class="pagination">
    <span id="page-info"></span>
    <span>
      Rows per page:
      <select id="rowsPerPage">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="250">250</option>
      </select>
    </span>
    <button id="prevPage">&laquo; Prev</button>
    <button id="nextPage">Next &raquo;</button>
  </div>

  <%- include('partials/footer') %>

    <script>
    // Merchant switcher (exists only on item view)
    const merchantSelect = document.getElementById('merchantSelect');
    if (merchantSelect) {
      merchantSelect.addEventListener('change', () => {
        const val = merchantSelect.value;
        if (val) {
          window.location.href = val;
        }
      });
    }

    // View mode switcher
    const viewSelect = document.getElementById('viewSelect');
    if (viewSelect) {
      viewSelect.addEventListener('change', () => {
        const val = viewSelect.value;
        if (val) {
          window.location.href = val;
        }
      });
    }

    // ---------- Data & table state (now loaded via API) ----------

    const DASHBOARD_MERCHANT_ID = <%- JSON.stringify(merchantId || null) %>;

    let pages = [];      // array of { rows, nextCursor }
    let cursors = [null]; // cursors[pageIndex] = cursor used to load that page's data
    let currentPageIndex = 0;

    let rowsPerPage = 50;
    const tbody = document.getElementById('inventory-body');
    const pageInfo = document.getElementById('page-info');
    const rowsPerPageSelect = document.getElementById('rowsPerPage');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const searchInput = document.getElementById('search');
    const headerCells = Array.from(
      document.querySelectorAll('#inventory-table thead th.sortable')
    );

    // Current page rows after search/sort
    let currentRows = [];
    let currentSort = {
      key: null,
      direction: 'asc',
    };

    // ---------- Helper: transform raw row ----------

    function mapRow(r, idx) {
      return {
        _index: idx,
        id: r.id || r.docId || '',
        merchant_name: r.merchant_name || r.merchant_id || '',
        location_name: r.location_name || r.location_id || '',
        category_name: r.category_name || '',
        item_name: r.item_name || '',
        variation_name: r.variation_name || '',
        sku: r.sku || '',
        gtin: r.gtin || '',
        qty: (r.qty !== undefined && r.qty !== null) ? Number(r.qty) : null,
        state: r.state || '',
        price: (r.price !== undefined && r.price !== null) ? Number(r.price) : null,
        currency: r.currency || '',
        tax_names: Array.isArray(r.tax_names) ? r.tax_names : [],
        tax_percentages: Array.isArray(r.tax_percentages) ? r.tax_percentages : [],
        calculated_at: r.calculated_at || r.updated_at || '',
        image_urls: Array.isArray(r.image_urls)
          ? r.image_urls
          : (r.image_urls ? [r.image_urls] : []),
      };
    }

    // ---------- API fetch ----------

    async function fetchPage(pageIndexToLoad) {
      const cursor = cursors[pageIndexToLoad] || null;
      const size = rowsPerPage;

      const params = new URLSearchParams();
      params.set('pageSize', size.toString());
      if (DASHBOARD_MERCHANT_ID) {
        params.set('merchantId', DASHBOARD_MERCHANT_ID);
      }
      if (cursor) {
        params.set('cursor', cursor);
      }

      const url = '/api/inventory?' + params.toString();
      console.log('Fetching inventory page:', url);

      const res = await fetch(url);
      if (!res.ok) {
        console.error('Failed to load inventory page:', await res.text());
        throw new Error('Failed to load inventory');
      }
      const data = await res.json();
      const rawRows = data.rows || [];
      const mapped = rawRows.map(mapRow);

      const nextCursor = data.nextCursor || null;

      // store this page
      pages[pageIndexToLoad] = {
        rows: mapped,
        nextCursor,
      };

      // store cursor for NEXT page
      cursors[pageIndexToLoad + 1] = nextCursor;

      return mapped;
    }

    async function loadPage(pageIndex) {
      currentPageIndex = pageIndex;

      let page = pages[pageIndex];

      if (!page) {
        const rows = await fetchPage(pageIndex);
        page = pages[pageIndex];
      }

      let pageRows = page.rows || [];

      // apply current search filter
      const q = (searchInput.value || '').trim().toLowerCase();
      if (q) {
        pageRows = pageRows.filter((r) => {
          const textParts = [
            r.merchant_name,
            r.location_name,
            r.category_name,
            r.item_name,
            r.variation_name,
            r.sku,
            r.gtin,
            r.state,
            r.currency,
            r.tax_names.join(', '),
            r.calculated_at,
          ];
          return textParts.join(' ').toLowerCase().includes(q);
        });
      }

      // sort inside page
      if (currentSort.key) {
        const key = currentSort.key;
        const type = currentSort.type || 'string';
        const dir = currentSort.direction === 'asc' ? 1 : -1;

        pageRows.sort((a, b) => {
          const va = a[key];
          const vb = b[key];

          if (type === 'number') {
            const na =
              va === null || va === undefined || isNaN(va) ? 0 : Number(va);
            const nb =
              vb === null || vb === undefined || isNaN(vb) ? 0 : Number(vb);
            if (na < nb) return -1 * dir;
            if (na > nb) return 1 * dir;
            return 0;
          } else {
            const sa = (
              Array.isArray(va) ? va.join(', ') : (va || '')
            )
              .toString()
              .toLowerCase();
            const sb = (
              Array.isArray(vb) ? vb.join(', ') : (vb || '')
            )
              .toString()
              .toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return 1 * dir;
            return 0;
          }
        });
      }

      currentRows = pageRows;
      renderTable();
    }

    // ---------- Rendering ----------

    function renderTable() {
      tbody.innerHTML = '';

      const total = currentRows.length;
      if (total === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 14; // 14 columns including Image
        td.textContent = 'No inventory rows found.';
        tr.appendChild(td);
        tbody.appendChild(tr);

        pageInfo.textContent = `Page ${currentPageIndex + 1} (0 rows)`;
        prevBtn.disabled = currentPageIndex <= 0;
        nextBtn.disabled =
          !pages[currentPageIndex] ||
          !pages[currentPageIndex].nextCursor;
        return;
      }

      currentRows.forEach((r) => {
        const tr = document.createElement('tr');

        const taxText =
          r.tax_names && r.tax_names.length
            ? r.tax_names.join(', ') +
              (r.tax_percentages && r.tax_percentages.length
                ? ' (' + r.tax_percentages.join(', ') + ' %)'
                : '')
            : '';

        // Image cell
        const imgTd = document.createElement('td');
        imgTd.className = 'thumb-cell';
        if (r.image_urls && r.image_urls.length) {
          const img = document.createElement('img');
          img.src = r.image_urls[0];
          img.alt = r.item_name || 'Item image';
          img.loading = 'lazy';
          img.className = 'thumb-img';
          imgTd.appendChild(img);
        } else {
          const span = document.createElement('span');
          span.className = 'thumb-placeholder';
          span.textContent = 'â€“';
          imgTd.appendChild(span);
        }
        tr.appendChild(imgTd);

        const cells = [
          r.merchant_name,
          r.location_name,
          r.category_name,
          r.item_name,
          r.variation_name,
          r.sku,
          r.gtin,
          r.qty !== null && r.qty !== undefined ? r.qty : '',
          r.state,
          r.price !== null && r.price !== undefined
            ? r.price.toFixed(2)
            : '',
          r.currency,
          taxText,
          r.calculated_at,
        ];

        cells.forEach((text) => {
          const td = document.createElement('td');
          td.textContent = text;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      const page = pages[currentPageIndex];
      const hasNext = page && page.nextCursor;

      pageInfo.textContent = `Page ${currentPageIndex + 1} (rows: ${currentRows.length})`;

      prevBtn.disabled = currentPageIndex <= 0;
      nextBtn.disabled = !hasNext;
    }

    // ---------- Sorting ----------

    function clearSortIndicators() {
      headerCells.forEach((th) => {
        th.classList.remove('sorted-asc', 'sorted-desc');
      });
    }

    function sortBy(key, type) {
      if (!key) return;

      if (currentSort.key === key) {
        currentSort.direction =
          currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = key;
        currentSort.direction = 'asc';
      }
      currentSort.type = type || 'string';

      clearSortIndicators();
      headerCells.forEach((th) => {
        if (th.dataset.key === key) {
          th.classList.add(
            currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc'
          );
        }
      });

      // re-sort current page only
      if (pages[currentPageIndex]) {
        loadPage(currentPageIndex);
      }
    }

    headerCells.forEach((th) => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        const type = th.dataset.type || 'string';
        sortBy(key, type);
      });
    });

    // ---------- Search (within current page) ----------

    searchInput.addEventListener('input', () => {
      if (pages[currentPageIndex]) {
        loadPage(currentPageIndex);
      }
    });

    // ---------- Pagination controls ----------

    rowsPerPageSelect.addEventListener('change', () => {
      rowsPerPage = Number(rowsPerPageSelect.value) || 50;
      // Reset pages & cursors and reload from first page
      pages = [];
      cursors = [null];
      currentPageIndex = 0;
      loadPage(0);
    });

    prevBtn.addEventListener('click', () => {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        loadPage(currentPageIndex);
      }
    });

    nextBtn.addEventListener('click', () => {
      const page = pages[currentPageIndex];
      if (page && page.nextCursor) {
        currentPageIndex++;
        loadPage(currentPageIndex);
      }
    });

    // ---------- Initial render (load first page) ----------

    (async () => {
      rowsPerPage = Number(rowsPerPageSelect.value) || 50;
      await loadPage(0);
    })();
  </script>

</body>
</html>
