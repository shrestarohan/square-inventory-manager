<!-- Global top loading bar (shown/hidden by page JS) -->
<div id="top-loader" class="top-loader" aria-hidden="true">
  <div id="top-loader-bar" class="top-loader__bar"></div>
</div>

<div class="top-bar">
  <!-- Row 1: Title (left) + User/Logout (right) -->
  <div class="top-row top-row-main">
    <div class="nav-title">
      <div class="brand-stack">
        <p class="brand-title">Square Inventory Sync</p>
        <p class="brand-subtitle">
          <%= pageTitle || 'Inventory Dashboard' %>
          <% if (currentView === 'item' && merchant && merchant.business_name) { %>
            – <%= merchant.business_name %>
          <% } else if (currentView === 'item') { %>
            – All Merchants
          <% } else if (currentView === 'gtin') { %>
            – GTIN Master
          <% } %>
        </p>
      </div>
    </div>

    <div class="nav-user">
      <% const safeUser = (typeof user !== 'undefined') ? user : null; %>
      <% if (safeUser) { %>
        <span class="user-info">
          Logged in as <strong><%= safeUser.email %></strong>
        </span>
        <form action="/logout" method="POST" class="logout-form">
          <button type="submit" class="btn btn-sm btn-outline-danger">
            Logout
          </button>
        </form>
      <% } else { %>
        <a href="/auth/google" class="btn btn-sm btn-primary">
          Login with Google
        </a>
      <% } %>
    </div>
  </div>

  <!-- Row 2: Main navigation (pages) -->
  <div class="top-row top-row-nav">
    <nav class="main-nav">
      <a href="/dashboard" class="nav-link <%= activePage === 'dashboard' ? 'active' : '' %>">
        Dashboard
      </a>

      <a href="/dashboard-gtin" class="nav-link <%= activePage === 'dashboard-gtin' ? 'active' : '' %>">
        Item Price Mismatch
      </a>

      <a href="/dashboard-vendor-costs" class="nav-link <%= activePage === 'dashboard-vendor-costs' ? 'active' : '' %>">
        Item Vendor and Costs
      </a>

      <a href="/duplicates-gtin" class="nav-link <%= activePage === 'duplicates-gtin' ? 'active' : '' %>">
        Duplicate GTINs
      </a>

      <a href="/inventory-integrity" class="nav-link <%= activePage === 'inventory-integrity' ? 'active' : '' %>">
        Negative Items
      </a>

      <a href="/reports" class="nav-link <%= activePage === 'reports' ? 'active' : '' %>">
        Reports
      </a>

      <a href="/reorder" class="nav-link <%= activePage === 'reorder' ? 'active' : '' %>">Reorder</a>

    </nav>
  </div>
  
  <% var hideFilters = (typeof showFilters !== 'undefined') ? !showFilters : false; %>

  <% if (!hideFilters) { %>
    <!-- Row 3: Filters (merchant + search) -->
    <div class="top-row top-row-filters">
      <div class="nav-left">
        <% if (currentView === 'item') { %>
          <div class="nav-block">
            <label for="merchantSelect"><strong>Merchant:</strong></label>
            <select id="merchantSelect">
              <option value="/dashboard" <%= !merchantId ? 'selected' : '' %>>
                All Merchants (Master)
              </option>
              <% if (merchants && merchants.length) { %>
                <% merchants.forEach(m => { %>
                  <option value="/dashboard/<%= m.id %>" <%= merchantId === m.id ? 'selected' : '' %>>
                    <%= m.business_name || m.id %>
                  </option>
                <% }) %>
              <% } %>
            </select>
          </div>
        <% } else if (currentView === 'gtin') { %>
          <div class="nav-block">
            <label style="display:flex;gap:8px;align-items:center;">
              <span style="opacity:.75;"><strong>Show:</strong></span>
              <select id="mismatchFilter">
                <option value="all" selected>All rows</option>
                <option value="mismatch">Price mismatch only</option>
              </select>
            </label>
          </div>
        <% } %>
      </div>

      <div class="filters" style="display:flex;align-items:center;gap:8px;">
        <input id="search" placeholder="Search by item, SKU, GTIN, merchant, location, category..." />
        <span id="mini-spinner" class="mini-spinner" aria-hidden="true"></span>
        <span id="load-status"></span>
      </div>
    </div>
  <% } %>
</div>
