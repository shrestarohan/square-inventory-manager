name: PR Preview Deploy (Staging)

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PROJECT_ID: square-inventory-480509
  REGION: us-central1
  AR_REPO: containers
  SERVICE_NAME: square-inventory-sync-staging
  IMAGE_NAME: square-inventory-sync

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build & Push image
        run: |
          PR="${{ github.event.pull_request.number }}"
          IMAGE_URI="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:pr-${PR}-${{ github.sha }}"
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "PR=$PR" >> $GITHUB_ENV

      - name: Deploy to Cloud Run (Preview on staging service)
        run: |
          # Deploy a revision tagged with PR number; keep staging env
          gcloud run deploy "${{ env.SERVICE_NAME }}" \
            --image "$IMAGE_URI" \
            --region "${{ env.REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --tag "pr-${PR}" \
            --set-env-vars "APP_ENV=staging,PREVIEW_PR=${PR}"

      - name: Fetch preview URL
        id: url
        run: |
          URL="$(gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region "${{ env.REGION }}" \
            --format='value(status.traffic[0].url)')"
          # The --tag creates a tagged URL like https://pr-123---service-xxxxx.a.run.app
          # Unfortunately gcloud doesn't directly output tagged URLs in a simple field,
          # so we reconstruct it from the service URL + tag format:
          # Tag URL format: https://<tag>---<service-hash>-<region>.a.run.app
          #
          # Easiest reliable method: list revisions with tags and print URL from traffic.
          TAG_URL="$(gcloud run services describe "${{ env.SERVICE_NAME }}" \
            --region "${{ env.REGION }}" \
            --format="value(status.traffic[?tag=='pr-${PR}'].url)")"

          if [ -z "$TAG_URL" ]; then
            TAG_URL="$URL"
          fi

          echo "TAG_URL=$TAG_URL" >> $GITHUB_OUTPUT

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const url = `${{ toJson(steps.url.outputs.TAG_URL) }}`.replaceAll('"','');
            const pr = context.payload.pull_request.number;
            const body =
              `âœ… PR Preview deployed to Cloud Run\n\n` +
              `**Preview URL:** ${url}\n\n` +
              `Image: \`${process.env.IMAGE_URI}\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body
            });

